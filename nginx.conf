events {}

http {
    # Define upstreams for each microservice
    upstream user {
        server localhost:3001;
    }

    upstream cart {
        server localhost:3002;
    }

    upstream product-catalog {
        server localhost:3003;
    }

    upstream order {
        server localhost:3004;
    }

    upstream payment {
        server localhost:3005;
    }

    upstream notification {
        server localhost:3006;
    }

    upstream auth {
        server localhost:3007;
    }

    server {
        listen 80;
        server_name localhost;

        # Internal auth verification location (cannot be accessed directly)
        location /auth-verify {
            internal;
            proxy_pass http://auth/verify;
            proxy_set_header Authorization $http_authorization;  # Pass the auth header
        }

        location /api/auth/sign/ {
            proxy_pass http://auth/sign;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/auth/refresh/ {
            proxy_pass http://auth/refresh;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # User service (no authentication)
        location /api/user/ {
            proxy_pass http://user/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Cart service (authentication required)
        location /api/cart/ {
            auth_request /auth-verify;  # Perform authentication before proxying
            proxy_pass http://cart/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;  # Forward auth header
        }

        # Product catalog service (no authentication)
        location /api/product-catalog/ {
            proxy_pass http://product-catalog/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Order service (authentication required)
        location /api/order/ {
            auth_request /auth-verify;  # Perform authentication before proxying
            proxy_pass http://order/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Payment service (authentication required)
        location /api/payment/ {
            auth_request /auth-verify;  # Perform authentication before proxying
            proxy_pass http://payment/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Notification service (authentication required)
        location /api/notification/ {
            auth_request /auth-verify;  # Perform authentication before proxying
            proxy_pass http://notification/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }


    }
}